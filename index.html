<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KGN DA'WA College Mithur - Library Management System</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
<style>
  /* Reset and base styles */
  *, *::before, *::after { box-sizing: border-box; }
  body {
    margin: 0; padding: 0;
    font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #fff;
    color: #6b7280;
    font-size: 16px;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  h1, h2 {
    font-weight: 700;
    color: #111827;
    margin: 0 0 1rem 0;
    user-select: none;
  }
  h1 {
    font-size: 3rem;
    font-weight: 800;
  }
  h2 {
    font-size: 2rem;
  }
  p, label {
    font-size: 1rem;
    margin: 0 0 1rem 0;
    user-select: none;
  }
  a { color: #4a90e2; text-decoration: none; transition: color 0.25s ease; }
  a:hover, a:focus { color: #357ab8; outline: none; }

  /* Container and layout */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 4rem 2rem 6rem;
  }

  /* Navigation */
  nav.nav {
    position: sticky;
    top: 0;
    background: #fff;
    padding: 1rem 2rem;
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 1000;
  }
  nav.nav .logo {
    font-weight: 800;
    font-size: 1.75rem;
    color: #4a90e2;
    user-select: none;
  }
  nav.nav .nav-items {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
  }
  nav.nav .nav-items button {
    background: transparent;
    border: none;
    font-weight: 600;
    font-size: 1rem;
    color: #6b7280;
    cursor: pointer;
    padding: 0.4rem 0.9rem;
    border-radius: 0.5rem;
    transition: background-color 0.3s ease, color 0.3s ease;
    user-select: none;
  }
  nav.nav .nav-items button:hover,
  nav.nav .nav-items button.active {
    background-color: #4a90e2;
    color: #fff;
  }

  /* Login Section */
  #login-view {
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 1rem;
  }
  #login-box {
    background: white;
    max-width: 400px;
    width: 100%;
    padding: 3rem 3rem 2rem 3rem;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    text-align: center;
  }
  #login-box h1 {
    margin-bottom: 0.5rem;
  }
  #login-box h2 {
    color: #374151;
    font-weight: 600;
    margin-bottom: 1.5rem;
  }
  #login-box label {
    display: block;
    text-align: left;
    margin-bottom: 0.4rem;
    font-weight: 600;
    color: #374151;
    font-size: 1rem;
  }
  #login-box input {
    width: 100%;
    padding: 0.75rem 1rem;
    margin-bottom: 1.5rem;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }
  #login-box input:focus {
    border-color: #4a90e2;
    box-shadow: 0 0 10px rgba(74,144,226,0.4);
    outline: none;
  }
  #login-box button {
    width: 100%;
    padding: 1rem;
    font-size: 1.25rem;
    font-weight: 700;
    color: white;
    background: linear-gradient(90deg, #4a90e2, #9013fe);
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  #login-box button:hover, #login-box button:focus {
    background: linear-gradient(90deg, #357ab8, #6e0bd7);
  }
  #login-error {
    color: #dc2626;
    font-weight: 600;
    margin-top: -0.8rem;
    margin-bottom: 1rem;
    display: none;
  }

  /* Book Search in login */
  #login-book-search-container {
    margin-top: 2rem;
  }
  #login-book-search-container input[type="text"] {
    width: 100%;
    padding: 0.7rem 1rem;
    font-size: 1rem;
    border-radius: 10px;
    border: 1px solid #d1d5db;
    transition: border-color 0.3s ease;
  }
  #login-book-search-container input[type="text"]:focus {
    border-color: #4a90e2;
    box-shadow: 0 0 10px rgba(74,144,226,0.4);
    outline: none;
  }

  /* Search results dropdown */
  #login-book-results {
    background: white;
    max-height: 250px;
    overflow-y: auto;
    margin-top: 0.5rem;
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    text-align: left;
    display: none;
    font-size: 0.9rem;
  }
  #login-book-results ul {
    list-style: none;
    padding: 0.5rem;
    margin: 0;
  }
  #login-book-results li {
    padding: 0.5rem 1rem;
    cursor: pointer;
    border-radius: 8px;
  }
  #login-book-results li:hover,
  #login-book-results li:focus {
    background-color: #e0e7ff;
    outline: none;
  }

  /* Main Content */
  #main-content {
    max-width: 1200px;
    margin: 0 auto;
  }

  /* Tabs container */
  .tab-content > section {
    display: none;
  }
  .tab-content > section.active {
    display: block;
  }

  /* Card */
  .card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    padding: 2rem 2.5rem;
    margin-bottom: 3rem;
  }

  /* Forms */
  form .form-group {
    margin-bottom: 1.5rem;
  }
  form .form-group label {
    color: #374151;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  form .form-group input,
  form .form-group select {
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    border: 1px solid #d1d5db;
    border-radius: 12px;
    transition: border-color 0.3s ease;
  }
  form .form-group input:focus,
  form .form-group select:focus {
    border-color: #4a90e2;
    box-shadow: 0 0 12px rgba(74, 144, 226, 0.5);
    outline: none;
  }
  form button.primary-btn {
    background-color: #4a90e2;
    color: white;
    font-weight: 700;
    font-size: 1.25rem;
    padding: 1rem 1.5rem;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  form button.primary-btn:hover,
  form button.primary-btn:focus {
    background-color: #357ab8;
  }

  /* Tables style */
  .scroll-table {
    max-height: 360px;
    overflow-y: auto;
    border-radius: 12px;
    box-shadow: inset 0 0 14px rgba(0,0,0,0.07);
    margin-bottom: 2.5rem;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 1rem;
  }
  th, td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    color: #374151;
    vertical-align: middle;
    user-select: none;
  }
  th {
    position: sticky;
    top: 0;
    background: #f3f4f6;
    font-weight: 700;
    z-index: 5;
  }
  tr:hover {
    background-color: #e0e7ff;
  }
  button.edit-btn, button.delete-btn {
    padding: 0.3rem 0.8rem;
    font-size: 0.95rem;
    border-radius: 10px;
    color: white;
    border: none;
    font-weight: 700;
    user-select: none;
    margin-left: 0.5rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button.edit-btn {
    background-color: #4a90e2;
  }
  button.edit-btn:hover,
  button.edit-btn:focus {
    background-color: #357ab8;
  }
  button.delete-btn {
    background-color: #dc2626;
  }
  button.delete-btn:hover,
  button.delete-btn:focus {
    background-color: #b91c1c;
  }

  /* Borrow / Return Table Buttons */
  button.borrow-btn, button.return-btn {
    padding: 0.4rem 0.9rem;
    font-size: 1rem;
    border-radius: 10px;
    color: white;
    border: none;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button.borrow-btn {
    background-color: #10b981;
  }
  button.borrow-btn:hover, button.borrow-btn:focus {
    background-color: #059669;
  }
  button.return-btn {
    background-color: #ef4444;
  }
  button.return-btn:hover, button.return-btn:focus {
    background-color: #b91c1c;
  }

  /* Search box */
  .search-box {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
  }
  .search-box input[type="text"] {
    flex-grow: 1;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    border-radius: 12px;
    border: 1px solid #d1d5db;
    transition: border-color 0.25s ease;
  }
  .search-box input[type="text"]:focus {
    border-color: #4a90e2;
    box-shadow: 0 0 10px rgba(74,144,226,0.4);
    outline: none;
  }
  .search-box button {
    background-color: #4a90e2;
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
    padding: 0.8rem 1.5rem;
    cursor: pointer;
    border: none;
    border-radius: 12px;
    user-select: none;
    display: none; /* Hide search buttons since search is automatic */
  }
  .search-box button:hover,
  .search-box button:focus {
    background-color: #357ab8;
  }

  /* Bulk upload file input */
  input[type='file'] {
    margin-top: 0.5rem;
    border: none;
    outline: none;
  }

  /* Notification */
  .notification {
    background-color: #d1fae5;
    color: #065f46;
    border-radius: 12px;
    font-weight: 600;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    user-select: none;
  }

  /* Responsive */
  @media (max-width: 900px) {
    body {
      font-size: 14px;
    }
    nav.nav {
      padding: 1rem 1rem;
      flex-wrap: wrap;
    }
    nav.nav .nav-items {
      width: 100%;
      justify-content: center;
      margin-top: 0.5rem;
      gap: 1rem;
    }
    #main-content {
      padding: 2rem 1rem 3rem 1rem;
    }
    form button.primary-btn {
      width: 100%;
    }
  }
</style>
</head>
<body>
  <main>
    <section id="login-view" role="main" aria-label="Library Management Login">
      <div id="login-box">
        <h1>KGN DA'WA College Mithur</h1>
        <h2>Library Management Login</h2>
        <form id="login-form" novalidate>
          <label for="username">Username</label>
          <input id="username" name="username" type="text" autocomplete="username" required />
          <label for="password">Password</label>
          <input id="password" name="password" type="password" autocomplete="current-password" required />
          <div id="login-error" role="alert" aria-live="assertive"></div>
          <button type="submit">Login</button>
        </form>
        <div id="login-book-search-container" class="search-box" aria-label="Search books">
          <input id="login-book-search" type="text" placeholder="Search books by name, author or number" aria-describedby="loginSearchResults" autocomplete="off" />
        </div>
        <div id="login-book-results" role="listbox" aria-label="Book search results"></div>
      </div>
    </section>

    <section id="dashboard" style="display:none;" aria-live="polite">
      <nav class="nav" role="navigation" aria-label="Primary navigation">
        <div class="logo" tabindex="0">KGN DA'WA College Library</div>
        <div class="nav-items" role="menubar" aria-label="Main navigation">
          <button data-tab="books" role="tab" aria-selected="false" tabindex="-1">Books</button>
          <button data-tab="students" role="tab" aria-selected="false" tabindex="-1">Students</button>
          <button data-tab="history" role="tab" aria-selected="false" tabindex="-1">Library History</button>
          <button data-tab="borrowreturn" role="tab" aria-selected="false" tabindex="-1">Borrow / Return</button>
          <button data-tab="profile" role="tab" aria-selected="false" tabindex="-1">Profile</button>
          <button id="logout-btn" aria-label="Log out">Logout</button>
        </div>
      </nav>
      <main id="main-content" class="container">
        <div class="tab-content">
          <!-- Books tab -->
          <section id="tab-books" role="tabpanel" tabindex="-1" aria-hidden="true" class="card">
            <h2>Manage Books</h2>
            <form id="add-book-form" aria-label="Add a book" autocomplete="off">
              <div class="form-group">
                <label for="book-name">Book Name</label>
                <input id="book-name" type="text" required />
              </div>
              <div class="form-group">
                <label for="author-name">Author Name</label>
                <input id="author-name" type="text" required />
              </div>
              <div class="form-group">
                <label for="book-num">Book Number</label>
                <input id="book-num" type="text" required />
              </div>
              <button type="submit" class="primary-btn">Add Book</button>
              <div class="form-group" style="margin-top:1.5rem;">
                <label for="bulk-book-upload">Bulk Upload Books (CSV with columns: Name,Author,Number):</label>
                <input type="file" id="bulk-book-upload" accept=".csv" />
              </div>
            </form>
            <div class="search-box" aria-label="Search books">
              <input id="book-search" type="text" placeholder="Search books by name, author or number" />
            </div>
            <div class="scroll-table" tabindex="0" aria-live="polite" aria-atomic="true">
              <table id="books-table" role="grid" aria-label="Books list">
                <thead>
                  <tr><th>Name</th><th>Author</th><th>Number</th><th>Status</th><th>Actions</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>
          <!-- Students tab -->
          <section id="tab-students" role="tabpanel" tabindex="-1" aria-hidden="true" class="card">
            <h2>Manage Students</h2>
            <form id="add-student-form" aria-label="Add a student" autocomplete="off">
              <div class="form-group">
                <label for="student-name">Student Name</label>
                <input id="student-name" type="text" required />
              </div>
              <div class="form-group">
                <label for="student-id">Student ID (used as password)</label>
                <input id="student-id" type="text" required />
              </div>
              <button type="submit" class="primary-btn">Add Student</button>
              <div class="form-group" style="margin-top:1.5rem;">
                <label for="bulk-student-upload">Bulk Upload Students (CSV with columns: Name,ID):</label>
                <input type="file" id="bulk-student-upload" accept=".csv" />
              </div>
            </form>
            <div class="search-box" aria-label="Search students">
              <input id="student-search" type="text" placeholder="Search students by name or ID" />
            </div>
            <div class="scroll-table" tabindex="0" aria-live="polite" aria-atomic="true">
              <table id="students-table" role="grid" aria-label="Students list">
                <thead>
                  <tr><th>Name</th><th>ID</th><th>Batch</th><th>Actions</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>
          <!-- History tab -->
          <section id="tab-history" role="tabpanel" tabindex="-1" aria-hidden="true" class="card">
            <h2>Library History</h2>
            <div class="search-box" aria-label="Filter library history">
              <select id="history-filter" aria-label="Filter history">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly" selected>Monthly</option>
                <option value="yearly">Yearly</option>
                <option value="studentwise">Student-wise</option>
                <option value="return-daywise">Return Day-wise</option>
              </select>
              <input id="history-student-name" type="text" placeholder="Student name (filter for student-wise)" style="display:none;" aria-label="Filter by student name" />
            </div>
            <div style="margin-bottom: 1rem;">
              <button id="download-pdf" type="button" aria-label="Download history as PDF">Download PDF</button>
              <button id="download-word" type="button" aria-label="Download history as Word">Download Word</button>
            </div>
            <div class="scroll-table" tabindex="0" aria-live="polite" aria-atomic="true">
              <table id="history-table" role="grid" aria-label="Library history table">
                <thead>
                  <tr>
                    <th>Student Name</th><th>Student ID</th><th>Book Name</th><th>Book Number</th><th>Borrow Date</th><th>Return Date</th><th>Fine (₹)</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <!-- Borrow / Return tab (visible for students) -->
          <section id="tab-borrowreturn" role="tabpanel" tabindex="-1" aria-hidden="true" class="card">
            <h2>Borrow / Return Books</h2>
            <div class="search-box" aria-label="Search borrowable books">
              <input id="student-book-search" type="text" placeholder="Search books by name, author, or number" />
            </div>
            <div class="scroll-table" tabindex="0" aria-live="polite" aria-atomic="true">
              <table id="student-borrow-list-table" role="grid" aria-label="Borrowable books list">
                <thead><tr><th>Book Name</th><th>Author</th><th>Number</th><th>Status</th><th>Action</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>

            <h2>Your Borrow / Return History</h2>
            <div class="scroll-table" tabindex="0" aria-live="polite" aria-atomic="true" style="max-height: 300px;">
              <table id="student-borrow-return-history-table" role="grid" aria-label="Your borrow and return history">
                <thead><tr><th>Book Name</th><th>Borrow Date</th><th>Return Date</th><th>Fine (₹)</th><th>Action</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </section>

          <!-- Profile tab -->
          <section id="tab-profile" role="tabpanel" tabindex="-1" aria-hidden="true" class="card">
            <h2>Your Profile</h2>
            <form id="profile-form" autocomplete="off">
              <div class="form-group">
                <label for="profile-username">Username (readonly for students, editable for admin)</label>
                <input id="profile-username" type="text" readonly />
              </div>
              <div class="form-group" id="batch-group" style="display:none;">
                <label for="profile-batch">Batch Name</label>
                <input id="profile-batch" type="text" maxlength="50" />
              </div>
              <div class="form-group">
                <label for="profile-current-password">Current Password</label>
                <input id="profile-current-password" type="password" />
              </div>
              <div class="form-group">
                <label for="profile-new-password">New Password</label>
                <input id="profile-new-password" type="password" />
              </div>
              <button type="submit" class="primary-btn">Update Profile</button>
            </form>
          </section>
        </div>
      </main>
    </section>
  </main>

  <script>
    (() => {
      'use strict';

      // DOM Elements
      const loginView = document.getElementById('login-view');
      const dashboardView = document.getElementById('dashboard');
      const loginForm = document.getElementById('login-form');
      const loginError = document.getElementById('login-error');

      const navButtons = Array.from(document.querySelectorAll('.nav .nav-items button[data-tab]'));
      const tabContents = Array.from(document.querySelectorAll('.tab-content > section'));

      const profileUsernameInput = document.getElementById('profile-username');
      const profileBatchInput = document.getElementById('profile-batch');
      const batchGroup = document.getElementById('batch-group');
      const profileCurrentPwdInput = document.getElementById('profile-current-password');
      const profileNewPwdInput = document.getElementById('profile-new-password');
      const profileForm = document.getElementById('profile-form');

      const addBookForm = document.getElementById('add-book-form');
      const booksTableBody = document.querySelector('#books-table tbody');
      const bookSearchInput = document.getElementById('book-search');
      const bulkBookUpload = document.getElementById('bulk-book-upload');

      const addStudentForm = document.getElementById('add-student-form');
      const studentsTableBody = document.querySelector('#students-table tbody');
      const studentSearchInput = document.getElementById('student-search');
      const bulkStudentUpload = document.getElementById('bulk-student-upload');

      const historyFilterSelect = document.getElementById('history-filter');
      const historyStudentNameInput = document.getElementById('history-student-name');
      const historyTableBody = document.querySelector('#history-table tbody');
      const downloadPdfBtn = document.getElementById('download-pdf');
      const downloadWordBtn = document.getElementById('download-word');

      const logoutBtn = document.getElementById('logout-btn');

      // Borrow / Return elements for student
      const studentBookSearchInput = document.getElementById('student-book-search');
      const studentBorrowListBody = document.querySelector('#student-borrow-list-table tbody');
      const studentBorrowReturnHistoryBody = document.querySelector('#student-borrow-return-history-table tbody');

      // Book search elements for login page
      const loginBookSearchInput = document.getElementById('login-book-search');
      const loginBookResults = document.getElementById('login-book-results');

      // Storage keys
      const STORAGE = {
        ADMIN_PWD: 'library_admin_pwd',
        BOOKS: 'library_books',
        STUDENTS: 'library_students',
        BORROWS: 'library_borrows'
      };

      // Default admin credentials
      const ADMIN_USERNAME = 'admin';
      let ADMIN_PASSWORD = localStorage.getItem(STORAGE.ADMIN_PWD) || 'admin123';

      // Data Stores
      let books = [];
      let students = [];
      let borrows = [];

      // Current User
      let currentUser = null;
      let currentUserRole = null; // 'admin' or 'student'

      // Utility Functions
      function saveStorage(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
      }
      function loadStorage(key) {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : [];
        } catch { return []; }
      }
      function escapeHtml(text) {
        const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
        return text.replace(/[&<>"']/g, m => map[m]);
      }
      function formatDate(date) {
        if (!(date instanceof Date)) return '';
        return date.toLocaleDateString('en-IN', { year:'numeric', month:'short', day:'numeric' });
      }
      function debounce(fn, delay) {
        let timeoutId;
        return function(...args) {
          if(timeoutId) clearTimeout(timeoutId);
          timeoutId = setTimeout(() => fn.apply(this, args), delay);
        };
      }
      function showError(msg) {
        loginError.textContent = msg;
        loginError.style.display = 'block';
      }
      function hideError() {
        loginError.style.display = 'none';
        loginError.textContent = '';
      }

      // Initial Data Load
      function initData() {
        books = loadStorage(STORAGE.BOOKS);
        students = loadStorage(STORAGE.STUDENTS);
        borrows = loadStorage(STORAGE.BORROWS);
      }

      // Show Dashboard Based on Role
      function showDashboard() {
        loginView.style.display = 'none';
        dashboardView.style.display = 'block';

        if (currentUserRole === 'admin') {
          navButtons.forEach(btn => btn.style.display = 'inline-block');
          batchGroup.style.display = 'none';
          profileUsernameInput.readOnly = false;
          profileUsernameInput.value = ADMIN_USERNAME;
          profileBatchInput.value = '';
          openSection('books');
        } else {
          // Student
          navButtons.forEach(btn => {
            btn.style.display = (btn.dataset.tab === 'borrowreturn' || btn.dataset.tab === 'profile') ? 'inline-block' : 'none';
          });
          batchGroup.style.display = 'block';
          profileUsernameInput.readOnly = true;
          profileUsernameInput.value = currentUser.name;
          profileBatchInput.value = currentUser.batch || '';
          openSection('borrowreturn');
          renderStudentBorrowableBooks('');
          renderStudentBorrowReturnHistory();
        }
        resetNav();
        renderBooksTable();
        renderStudentsTable();
        renderHistoryTable();
        hideError();
      }
      function resetNav(){
        navButtons.forEach(btn => {
          if(btn.style.display !== 'none'){
            btn.classList.add('active');
            btn.setAttribute('aria-selected', 'true');
            btn.tabIndex = 0;
          } else {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
            btn.tabIndex = -1;
          }
        });
      }

      // Login Handler
      loginForm.addEventListener('submit', e => {
        e.preventDefault();
        hideError();
        const username = loginForm.username.value.trim();
        const password = loginForm.password.value.trim();

        if(!username || !password) {
          showError('Please enter username and password.');
          return;
        }
        if(username.toLowerCase() === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
          currentUser = { username: ADMIN_USERNAME};
          currentUserRole = 'admin';
          showDashboard();
          return;
        }
        let student = students.find(s => s.name.toLowerCase() === username.toLowerCase() && s.id === password);
        if(student) {
          currentUser = {...student};
          currentUserRole = 'student';
          showDashboard();
          return;
        }
        showError('Invalid username or password.');
      });

      // Logout Handler
      logoutBtn.addEventListener('click', () => {
        currentUser = null;
        currentUserRole = null;
        dashboardView.style.display = 'none';
        loginView.style.display = 'flex';
        loginForm.username.focus();
        loginForm.reset();
        clearLoginBookResults();
        loginBookSearchInput.value = '';
      });

      // Navigation Tab Switches
      navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          if(btn.style.display === 'none') return;
          openSection(btn.dataset.tab);
          navButtons.forEach(el => {
            el.classList.remove('active');
            el.setAttribute('aria-selected', 'false');
            el.tabIndex = -1;
          });
          btn.classList.add('active');
          btn.setAttribute('aria-selected', 'true');
          btn.tabIndex = 0;

          if(btn.dataset.tab === 'borrowreturn' && currentUserRole === 'student'){
            renderStudentBorrowableBooks('');
            renderStudentBorrowReturnHistory();
          }
        });
      });

      // Book addition (Single)
      addBookForm.addEventListener('submit', e => {
        e.preventDefault();
        const name = document.getElementById('book-name').value.trim();
        const author = document.getElementById('author-name').value.trim();
        const number = document.getElementById('book-num').value.trim();
        if(!name || !author || !number) { alert('Please complete all book fields.'); return; }
        if(books.some(b => b.number.toLowerCase() === number.toLowerCase())) { alert('Book number must be unique.'); return; }
        books.push({name, author, number, borrowedBy: null});
        saveStorage(STORAGE.BOOKS, books);
        addBookForm.reset();
        renderBooksTable();
      });

      // Bulk Book upload (CSV)
      bulkBookUpload.addEventListener('change', e => {
        if(e.target.files.length === 0) return;
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = ev => {
          const csv = ev.target.result;
          parseCsvBooks(csv);
          e.target.value = "";
        };
        reader.readAsText(file);
      });

      function parseCsvBooks(csvText) {
        let lines = csvText.trim().split(/\r?\n/);
        if(lines.length < 2) { alert('CSV is empty or no data'); return; }
        let count=0, skipped=0;
        for(let i=1; i<lines.length; i++){
          let cols = lines[i].split(",");
          if(cols.length < 3){ skipped++; continue; }
          let [name, author, number] = cols.map(c=>c.trim());
          if(!name || !author || !number || books.some(b => b.number.toLowerCase() === number.toLowerCase())){
            skipped++;
            continue;
          }
          books.push({name, author, number, borrowedBy: null});
          count++;
        }
        saveStorage(STORAGE.BOOKS, books);
        renderBooksTable();
        alert(`Bulk upload complete: added ${count} books, skipped ${skipped}.`);
      }

      // Book Search and Table Rendering
      bookSearchInput.addEventListener('input', debounce(renderBooksTable, 250));
      function renderBooksTable() {
        const filter = bookSearchInput.value.trim().toLowerCase();
        let filtered = filter ? books.filter(b => (b.name + b.author + b.number).toLowerCase().includes(filter)) : books;
        booksTableBody.innerHTML = "";
        if(filtered.length === 0) {
          booksTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#9ca3af;">No books found.</td></tr>';
          return;
        }
        filtered.forEach(b => {
          let status = b.borrowedBy ? `Borrowed by ${escapeHtml(b.borrowedBy.name)}` : 'Available';
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(b.name)}</td><td>${escapeHtml(b.author)}</td><td>${escapeHtml(b.number)}</td><td>${status}</td><td>
            <button class="edit-btn" data-book="${b.number}" aria-label="Edit book ${escapeHtml(b.name)}">Edit</button>
            <button class="delete-btn" data-book="${b.number}" aria-label="Delete book ${escapeHtml(b.name)}">Delete</button>
          </td>`;
          booksTableBody.appendChild(tr);
        });
        attachBookEvents();
      }
      function attachBookEvents(){
        document.querySelectorAll('button.edit-btn[data-book]').forEach(btn => {
          btn.onclick = () => {
            const bnum = btn.dataset.book;
            const book = books.find(b=>b.number === bnum);
            if(book) openEditModal('book', book);
          };
        });
        document.querySelectorAll('button.delete-btn[data-book]').forEach(btn =>{
          btn.onclick = () => {
            if(confirm("Delete this book and associated borrow records?")){
              books = books.filter(b=>b.number !== btn.dataset.book);
              borrows = borrows.filter(b=>b.bookNumber !== btn.dataset.book);
              saveStorage(STORAGE.BOOKS, books);
              saveStorage(STORAGE.BORROWS, borrows);
              renderBooksTable();
              renderHistoryTable();
            }
          };
        });
      }

      // Students Add (single and bulk)
      addStudentForm.addEventListener('submit', e=>{
        e.preventDefault();
        const name = document.getElementById('student-name').value.trim();
        const id = document.getElementById('student-id').value.trim();
        if(!name || !id){ alert("Please fill all student fields."); return; }
        if(students.some(s=>s.id.toLowerCase() === id.toLowerCase() || s.name.toLowerCase() === name.toLowerCase())){
          alert("Duplicate student id or name.");
          return;
        }
        students.push({name, id, batch: ""});
        saveStorage(STORAGE.STUDENTS, students);
        addStudentForm.reset();
        renderStudentsTable();
      });
      bulkStudentUpload.addEventListener('change', e=>{
        if(!e.target.files.length) return;
        const reader = new FileReader();
        reader.onload = ev => {
          const csv = ev.target.result;
          parseCsvStudents(csv);
          e.target.value = "";
        };
        reader.readAsText(e.target.files[0]);
      });
      function parseCsvStudents(csv){
        const lines = csv.trim().split(/\r?\n/);
        if(lines.length<2){alert("No data in CSV."); return;}
        let success = 0, skipped = 0;
        for(let i=1; i<lines.length; i++){
          const cols = lines[i].split(",");
          if(cols.length<2){ skipped++; continue; }
          const [name, id] = cols.map(c=>c.trim());
          if(!name || !id || students.some(s=>s.id.toLowerCase() === id.toLowerCase() || s.name.toLowerCase() === name.toLowerCase())){
            skipped++;
            continue;
          }
          students.push({name, id, batch: ""});
          success++;
        }
        saveStorage(STORAGE.STUDENTS, students);
        renderStudentsTable();
        alert(`Bulk upload complete: ${success} students added, ${skipped} skipped.`);
      }

      studentSearchInput.addEventListener('input', debounce(renderStudentsTable, 250));
      function renderStudentsTable(){
        const filter = studentSearchInput.value.trim().toLowerCase();
        let filtered = filter? students.filter(s => (s.name + s.id).toLowerCase().includes(filter)) : students;
        studentsTableBody.innerHTML = '';
        if(filtered.length === 0){
          studentsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#9ca3af;">No students found.</td></tr>';
          return;
        }
        filtered.forEach(s => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.id)}</td><td>${escapeHtml(s.batch || '')}</td><td>
            <button class="edit-btn" data-student="${s.id}">Edit</button><button class="delete-btn" data-student="${s.id}">Delete</button>
          </td>`;
          studentsTableBody.appendChild(tr);
        });
        attachStudentEvents();
      }
      function attachStudentEvents(){
        document.querySelectorAll('button.edit-btn[data-student]').forEach(btn =>{
          btn.onclick = () => {
            const sid = btn.dataset.student;
            const student = students.find(s => s.id === sid);
            if(student) openEditModal('student', student);
          };
        });
        document.querySelectorAll('button.delete-btn[data-student]').forEach(btn => {
          btn.onclick = () => {
            if(confirm("Delete this student and all related borrow records?")){
              let sid = btn.dataset.student;
              students = students.filter(s => s.id !== sid);
              borrows = borrows.filter(b => b.studentId !== sid);
              saveStorage(STORAGE.STUDENTS, students);
              saveStorage(STORAGE.BORROWS, borrows);
              renderStudentsTable();
              renderHistoryTable();
            }
          };
        });
      }

      // History Filter change events
      historyFilterSelect.addEventListener('change', () => {
        historyStudentNameInput.style.display = (historyFilterSelect.value === "studentwise") ? "inline-block" : "none";
        if(historyFilterSelect.value !== "studentwise") historyStudentNameInput.value = "";
        renderHistoryTable();
      });
      historyStudentNameInput.addEventListener('input', debounce(renderHistoryTable, 300));

      function renderHistoryTable() {
        const filter = historyFilterSelect.value;
        const studentFilter = historyStudentNameInput.value.trim().toLowerCase();
        let filtered = borrows.filter(b => b.returnDate);
        const now = new Date();

        if(filter==='daily') {
          filtered = filtered.filter(b => new Date(b.returnDate).toDateString() === now.toDateString());
        } else if(filter==='weekly') {
          filtered = filtered.filter(b => {
            const retD = new Date(b.returnDate);
            let days = (now-retD)/(1000*60*60*24);
            return days>=0 && days<=7;
          });
        } else if(filter==='monthly') {
          filtered = filtered.filter(b => {
            const retD = new Date(b.returnDate);
            return retD.getMonth() === now.getMonth() && retD.getFullYear() === now.getFullYear();
          });
        } else if(filter==='yearly') {
          filtered = filtered.filter(b => new Date(b.returnDate).getFullYear() === now.getFullYear());
        } else if(filter==='studentwise' && studentFilter) {
          filtered = filtered.filter(b => b.studentName.toLowerCase().includes(studentFilter));
        } else if(filter==='return-daywise') {
          filtered.sort((a,b) => new Date(a.returnDate) - new Date(b.returnDate));
        }

        historyTableBody.innerHTML = '';
        if(filtered.length === 0){
          historyTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#9ca3af;">No records found.</td></tr>';
          return;
        }
        filtered.forEach(b => {
          const borrowDate = formatDate(new Date(b.borrowDate));
          const returnDate = formatDate(new Date(b.returnDate));
          const fine = b.fine ? b.fine.toFixed(2) : "0";
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(b.studentName)}</td><td>${escapeHtml(b.studentId)}</td><td>${escapeHtml(b.bookName)}</td><td>${escapeHtml(b.bookNumber)}</td><td>${borrowDate}</td><td>${returnDate}</td><td>${fine}</td>`;
          historyTableBody.appendChild(tr);
        });
      }

      // Export functions for history
      downloadPdfBtn.addEventListener('click', () => exportHistory('pdf'));
      downloadWordBtn.addEventListener('click', () => exportHistory('word'));

      function exportHistory(format){
        const header = "KGN Dawa College Mithur - Library History";
        const tableHTML = document.getElementById('history-table').outerHTML;
        const content = `<html><head><title>${header}</title><style>body{font-family:Arial,sans-serif;padding:20px;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}th{background:#f2f2f2;}</style></head><body><h1>${header}</h1>${tableHTML}</body></html>`;
        if(format === 'pdf'){
          const win = window.open('', '_blank', 'width=900,height=700');
          win.document.write(content);
          win.document.close();
          win.focus();
          win.onload = () => win.print();
        } else {
          const blob = new Blob(['\ufeff', content], {type: 'application/msword'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'library-history.doc';
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 0);
        }
      }

      // Login page book search logic - auto search on input with debounce
      loginBookSearchInput.addEventListener('input', debounce(performLoginBookSearch, 300));

      function performLoginBookSearch() {
        const query = loginBookSearchInput.value.trim().toLowerCase();
        clearLoginBookResults();
        if (!query) return;
        const matches = books.filter(b => (b.name + ' ' + b.author + ' ' + b.number).toLowerCase().includes(query));
        if (matches.length === 0) {
          loginBookResults.style.display = 'block';
          loginBookResults.innerHTML = '<ul><li tabindex="0">No books found.</li></ul>';
          return;
        }
        const ul = document.createElement('ul');
        matches.forEach(book => {
          const li = document.createElement('li');
          li.tabIndex = 0;
          li.textContent = `${book.name} by ${book.author} (Number: ${book.number}) - ${book.borrowedBy ? 'Borrowed' : 'Available'}`;
          ul.appendChild(li);
        });
        loginBookResults.appendChild(ul);
        loginBookResults.style.display = 'block';
      }

      function clearLoginBookResults() {
        loginBookResults.style.display = 'none';
        loginBookResults.innerHTML = '';
      }

      // Student Borrow / Return - auto search and render
      studentBookSearchInput.addEventListener('input', debounce(renderStudentBorrowableBooks, 300));

      function renderStudentBorrowableBooks() {
        if (currentUserRole !== 'student') return;
        const filter = studentBookSearchInput.value.trim().toLowerCase();
        let filtered = filter ? books.filter(b => (b.name + b.author + b.number).toLowerCase().includes(filter)) : books;
        studentBorrowListBody.innerHTML = '';
        if (!filtered.length) {
          studentBorrowListBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#9ca3af;">No books found.</td></tr>';
          return;
        }
        filtered.forEach(b => {
          const canBorrow = !b.borrowedBy;
          const status = canBorrow ? 'Available' : `Borrowed by ${escapeHtml(b.borrowedBy.name)}`;
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(b.name)}</td><td>${escapeHtml(b.author)}</td><td>${escapeHtml(b.number)}</td><td>${status}</td><td>${canBorrow ? '<button class="borrow-btn">Borrow</button>' : ''}</td>`;
          if (canBorrow) {
            tr.querySelector('button.borrow-btn').addEventListener('click', () => borrowBook(b.number));
          }
          studentBorrowListBody.appendChild(tr);
        });
      }

      function borrowBook(bookNumber) {
        if (currentUserRole !== 'student') {
          alert("Only students can borrow books.");
          return;
        }
        const student = students.find(s => s.name === currentUser.name && s.id === currentUser.id);
        if (!student) { alert("Student info missing."); return; }
        const book = books.find(b => b.number === bookNumber);
        if (!book || book.borrowedBy) { alert("Book not available."); return; }
        const now = new Date().toISOString();
        borrows.push({
          studentName: student.name,
          studentId: student.id,
          bookName: book.name,
          bookNumber: book.number,
          borrowDate: now,
          returnDate: null,
          fine: 0,
        });
        book.borrowedBy = { name: student.name, id: student.id };
        saveStorage(STORAGE.BORROWS, borrows);
        saveStorage(STORAGE.BOOKS, books);
        renderStudentBorrowableBooks();
        renderStudentBorrowReturnHistory();
        renderBooksTable();
        alert("Book borrowed successfully.");
      }

      function renderStudentBorrowReturnHistory() {
        if (currentUserRole !== 'student') return;
        const recs = borrows.filter(b => b.studentId === currentUser.id);
        studentBorrowReturnHistoryBody.innerHTML = '';
        if (!recs.length) {
          studentBorrowReturnHistoryBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#9ca3af;">No borrowing records.</td></tr>';
          return;
        }
        recs.forEach((b, i) => {
          const borrowDate = formatDate(new Date(b.borrowDate));
          const returnDate = b.returnDate ? formatDate(new Date(b.returnDate)) : "Not returned";
          const fine = b.fine ? b.fine.toFixed(2) : "0";
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(b.bookName)}</td><td>${borrowDate}</td><td>${returnDate}</td><td>${fine}</td><td>${!b.returnDate ? '<button class="return-btn">Return</button>' : ''}</td>`;
          if (!b.returnDate) {
            tr.querySelector('button.return-btn').addEventListener('click', () => returnBook(i));
          }
          studentBorrowReturnHistoryBody.appendChild(tr);
        });
      }

      function returnBook(index) {
        if (currentUserRole !== 'student') {
          alert("Only students can return books.");
          return;
        }
        const record = borrows[index];
        if (!record || record.returnDate) { alert("Invalid return operation."); return; }
        const returnDate = new Date();
        const borrowDate = new Date(record.borrowDate);
        const days = Math.floor((returnDate - borrowDate) / (1000 * 60 * 60 * 24));
        const fine = days > 7 ? (days - 7) * 5 : 0;
        record.returnDate = returnDate.toISOString();
        record.fine = fine;
        const book = books.find(b => b.number === record.bookNumber);
        if (book) book.borrowedBy = null;
        saveStorage(STORAGE.BORROWS, borrows);
        saveStorage(STORAGE.BOOKS, books);
        renderStudentBorrowReturnHistory();
        renderStudentBorrowableBooks();
        renderBooksTable();
        renderHistoryTable();
        alert(`Book returned successfully${fine > 0 ? `; Fine ₹${fine}` : ''}`);
      }

      // Profile Update
      profileForm.addEventListener('submit', e => {
        e.preventDefault();
        const newUsername = profileUsernameInput.value.trim();
        const batch = profileBatchInput.value.trim();
        const currentPwd = profileCurrentPwdInput.value;
        const newPwd = profileNewPwdInput.value;
        if (currentUserRole === 'admin') {
          if (currentPwd !== ADMIN_PASSWORD) { alert("Current password incorrect."); return; }
          if (newPwd && newPwd.length < 4) { alert("New password must be at least 4 characters."); return; }
          if (newUsername !== ADMIN_USERNAME) { alert("Admin username cannot be changed."); profileUsernameInput.value = ADMIN_USERNAME; return; }
          if (newPwd) { ADMIN_PASSWORD = newPwd; localStorage.setItem(STORAGE.ADMIN_PWD, newPwd); alert("Admin password changed."); }
          else alert("Profile updated.");
          profileCurrentPwdInput.value = ""; profileNewPwdInput.value = "";
        } else {
          if (currentPwd && currentPwd !== currentUser.id) { alert("Current password incorrect."); return; }
          if (newPwd && newPwd.length < 4) { alert("New password must be at least 4 characters."); return; }
          const idx = students.findIndex(s => s.name === currentUser.name && s.id === currentUser.id);
          if (idx === -1) { alert("Student record not found."); return; }
          students[idx].batch = batch;
          if (newPwd) { students[idx].id = newPwd; currentUser.id = newPwd; alert("Password changed."); }
          else alert("Profile updated.");
          saveStorage(STORAGE.STUDENTS, students);
          profileCurrentPwdInput.value = ""; profileNewPwdInput.value = "";
        }
      });

      // Initialize data and UI
      document.addEventListener('DOMContentLoaded', () => {
        initData();
        loginForm.username.focus();
        renderBooksTable();
        renderStudentsTable();
        renderHistoryTable();
      });

      // Modal edit placeholder
      function openEditModal(type, data) {
        alert('Edit feature is not implemented in this demo.');
      }

      // Section open function
      function openSection(name) {
        tabContents.forEach(sect => {
          if (sect.id === 'tab-' + name) {
            sect.classList.add('active');
            sect.setAttribute('aria-hidden', 'false');
            sect.tabIndex = 0;
          } else {
            sect.classList.remove('active');
            sect.setAttribute('aria-hidden', 'true');
            sect.tabIndex = -1;
          }
        });
      }

    })();
  </script>
</body>
</html>

